generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   СПРАВОЧНИКИ / ТИПЫ
   ========================= */

model block_reason_type {
  id   Int    @id @default(autoincrement())
  name String @db.VarChar(100)

  users_blocks users_blocks[]
}

model permission_type {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(100)

  role_permission role_permission[]
}

/* =========================
   ПОЛЬЗОВАТЕЛИ / ПРОФИЛИ
   ========================= */

model users {
  id            String  @id @default(uuid()) @db.Uuid
  email         String? @unique @db.VarChar(255)
  username      String? @unique @db.VarChar(255)
  password_hash String?
  number        String?

  user_preferences     user_preferences?
  user_profile         user_profile?
  user_server          user_server[]
  chats                chats[]       @relation("UserCreatedChats")
  chat_users           chat_users[]
  blocks_initiated     users_blocks[] @relation("BlockerRelation")
  blocks_received      users_blocks[] @relation("BlockedRelation")
  messages             messages[]
  friend_requests_from friend_requests[] @relation("RequestFrom")
  friend_requests_to   friend_requests[] @relation("RequestTo")
  created_servers      servers[]         @relation("UserCreatedServers")
  issue_assignee       issue_assignee[]

  server_bans    server_bans[]
  bans_made      server_bans[]        @relation("BanActor")
  invites        invites[]
  audit_logs     audit_logs[]
  message_reads  message_reads[]
  notifications  notifications[]
}

model user_preferences {
  user_id          String  @id @db.Uuid
  privacy_settings String?
  timezone         String? @db.VarChar(50)
  theme            String? @db.VarChar(20)
  created_at       DateTime?
  updated_at       DateTime?
  confirmed_at     DateTime?

  user users @relation(fields: [user_id], references: [id])
}

model user_profile {
  user_id    String  @id @db.Uuid
  first_name String? @db.VarChar(100)
  last_name  String? @db.VarChar(100)
  birth_date DateTime?
  avatar_url String?
  gender     String? @db.VarChar(20)
  location   String? @db.VarChar(100)
  about      String?
  is_online  Boolean @default(false)

  user users @relation(fields: [user_id], references: [id])
}

model users_blocks {
  id               Int       @id @default(autoincrement())
  id_users         String    @db.Uuid // кто блокирует
  blocked_user_id  String    @db.Uuid // кого блокируют
  reason_type_id   Int
  created_at       DateTime? @default(now())
  end_at           DateTime?

  blocker          users             @relation("BlockerRelation", fields: [id_users], references: [id])
  blocked          users             @relation("BlockedRelation", fields: [blocked_user_id], references: [id])
  block_reason_type block_reason_type @relation(fields: [reason_type_id], references: [id])

  @@unique([id_users, blocked_user_id])
}

/* =========================
   ДРУЖБА / ЗАПРОСЫ
   ========================= */

model friend_requests {
  from_user_id String @db.Uuid
  to_user_id   String @db.Uuid
  status       String
  created_at   DateTime? @default(now())

  from_user users @relation("RequestFrom", fields: [from_user_id], references: [id])
  to_user   users @relation("RequestTo", fields: [to_user_id], references: [id])

  @@id([from_user_id, to_user_id])
}

/* =========================
   СЕРВЕРЫ / РОЛИ / ПРАВА
   ========================= */

model servers {
  id         String   @id @default(uuid()) @db.Uuid
  creator_id String?  @db.Uuid
  name       String   @db.VarChar(100)
  avatar_url String?
  created_at DateTime?
  updated_at DateTime?

  creator      users?        @relation("UserCreatedServers", fields: [creator_id], references: [id])
  user_server  user_server[]
  server_chats server_chats[]

  roles   role_server[]
  project project[]

  server_bans server_bans[]
  invites     invites[]
  audit_logs  audit_logs[]
}

model role_server {
  id        String  @id @default(uuid()) @db.Uuid
  server_id String  @db.Uuid
  name      String  @db.VarChar(50)
  color     String? @db.VarChar(7)

  server          servers             @relation(fields: [server_id], references: [id])
  role_permission role_permission[]
  members         user_server_roles[]

  @@index([server_id])
}

model role_permission {
  role_id       String @db.Uuid
  permission_id Int
  granted_at    DateTime?

  role       role_server     @relation(fields: [role_id], references: [id])
  permission permission_type @relation(fields: [permission_id], references: [id])

  @@id([role_id, permission_id])
  @@index([role_id])
  @@index([permission_id])
}

model user_server {
  user_id    String   @db.Uuid
  server_id  String   @db.Uuid
  created_at DateTime?

  user   users   @relation(fields: [user_id], references: [id])
  server servers @relation(fields: [server_id], references: [id])

  roles user_server_roles[]

  @@id([user_id, server_id])
  @@index([server_id])
}

model user_server_roles {
  user_id   String @db.Uuid
  server_id String @db.Uuid
  role_id   String @db.Uuid

  user_server user_server @relation(fields: [user_id, server_id], references: [user_id, server_id])
  role        role_server @relation(fields: [role_id], references: [id])

  @@id([user_id, server_id, role_id])
  @@index([role_id])
}

/* Серверные баны */
model server_bans {
  server_id  String @db.Uuid
  user_id    String @db.Uuid
  reason     String?
  created_at DateTime? @default(now())
  banned_by  String? @db.Uuid

  server servers @relation(fields: [server_id], references: [id])
  user   users   @relation(fields: [user_id], references: [id])
  by     users?  @relation("BanActor", fields: [banned_by], references: [id])

  @@id([server_id, user_id])
  @@index([user_id])
}

/* Приглашения на сервер */
model invites {
  code       String  @id
  server_id  String  @db.Uuid
  creator_id String  @db.Uuid
  expires_at DateTime?
  max_uses   Int?
  uses       Int     @default(0)
  is_revoked Boolean @default(false)

  server  servers @relation(fields: [server_id], references: [id])
  creator users   @relation(fields: [creator_id], references: [id])

  @@index([server_id])
}

/* =========================
   КАНАЛЫ / ЧАТЫ / УЧАСТНИКИ
   ========================= */

model chats {
  id         String   @id @default(uuid()) @db.Uuid
  creator_id String?  @db.Uuid
  created_at DateTime?
  name       String?

  creator users? @relation("UserCreatedChats", fields: [creator_id], references: [id])

  chat_users    chat_users[]
  messages      messages[]
  server_chats  server_chats[]
  message_reads message_reads[]
  chat_issues   chat_issues[]
}

model server_chats {
  id_server String @db.Uuid
  id_chats  String @db.Uuid

  server servers @relation(fields: [id_server], references: [id])
  chat   chats   @relation(fields: [id_chats], references: [id])

  @@id([id_server, id_chats])
  @@index([id_server])
  @@index([id_chats])
}

model chat_users {
  user_id    String @db.Uuid
  chat_id    String @db.Uuid
  created_at DateTime?
  updated_at DateTime?

  users users @relation(fields: [user_id], references: [id])
  chats chats @relation(fields: [chat_id], references: [id])

  @@id([user_id, chat_id])
  @@index([chat_id])
}

/* =========================
   СООБЩЕНИЯ / КОНТЕНТ
   ========================= */

model messages {
  id           String   @id @default(uuid()) @db.Uuid
  chat_id      String?  @db.Uuid
  user_id      String?  @db.Uuid
  reply_to_id  String?  @db.Uuid
  is_edited    Boolean?
  updated_at   DateTime?
  created_at   DateTime?
  content_text String?

  chat chats? @relation(fields: [chat_id], references: [id])
  user users? @relation(fields: [user_id], references: [id])

  reply_to messages?  @relation("MessageReply", fields: [reply_to_id], references: [id])
  replies  messages[] @relation("MessageReply")

  messages_content messages_content[]

  @@index([chat_id, created_at])
  @@index([user_id, created_at])
  @@index([content_text])
}

model content {
  id   String @id @default(uuid()) @db.Uuid
  text String?
  url  String?

  messages_content messages_content[]
}

model messages_content {
  id_messages String @db.Uuid
  type        String?  @db.VarChar(50)
  size        Int?
  uploaded_at DateTime?
  id_content  String @db.Uuid

  message messages @relation(fields: [id_messages], references: [id])
  content content  @relation(fields: [id_content], references: [id])

  @@id([id_messages, id_content])
}

/* =========================
   МОДЕРАЦИЯ / ЛОГИ
   ========================= */

model audit_logs {
  id         String   @id @default(uuid()) @db.Uuid
  server_id  String   @db.Uuid
  actor_id   String   @db.Uuid
  action     String    @db.VarChar(50)
  target_id  String?
  metadata   String?
  created_at DateTime? @default(now())

  server servers @relation(fields: [server_id], references: [id])
  actor  users   @relation(fields: [actor_id], references: [id])

  @@index([server_id, created_at])
}

/* =========================
   УВЕДОМЛЕНИЯ / ПРОЧТЕНО
   ========================= */

model message_reads {
  user_id              String @db.Uuid
  chat_id              String @db.Uuid
  last_read_message_id String? @db.Uuid
  updated_at           DateTime? @default(now())

  user users @relation(fields: [user_id], references: [id])
  chat chats @relation(fields: [chat_id], references: [id])

  @@id([user_id, chat_id])
  @@index([chat_id])
}

model notifications {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  type       String   @db.VarChar(50)
  title      String   @db.VarChar(255)
  body       String?
  data       String?
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
}

/* =========================
   ПЛАНИРОВАНИЕ / ПРОЕКТЫ / ЗАДАЧИ
   ========================= */

model project {
  id          String   @id @default(uuid()) @db.Uuid
  server_id   String   @db.Uuid
  name        String   @db.VarChar(100)
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  server servers @relation(fields: [server_id], references: [id])

  project_issues project_issues[]
}

model issue {
  id          String        @id @default(uuid()) @db.Uuid
  title       String        @db.VarChar(200)
  description String?
  priority    IssuePriority @default(MEDIUM)
  status_id   Int
  due_date    DateTime?
  parent_id   String?       @db.Uuid
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  status  issue_status @relation(fields: [status_id], references: [id])
  parent  issue?       @relation("IssueParent", fields: [parent_id], references: [id])
  subtasks issue[]     @relation("IssueParent")

  assignees      issue_assignee[]
  project_issues project_issues[]
  chat_issues    chat_issues[]
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model project_issues {
  project_id String @db.Uuid
  issue_id   String @db.Uuid

  project project @relation(fields: [project_id], references: [id])
  issue   issue   @relation(fields: [issue_id], references: [id])

  @@id([project_id, issue_id])
}

model chat_issues {
  chat_id  String @db.Uuid
  issue_id String @db.Uuid

  chat  chats @relation(fields: [chat_id], references: [id])
  issue issue @relation(fields: [issue_id], references: [id])

  @@id([chat_id, issue_id])
}

model issue_status {
  id    Int    @id @default(autoincrement())
  name  String @db.VarChar(50) @unique

  issues issue[]
}

model issue_assignee {
  issue_id String @db.Uuid
  user_id  String @db.Uuid

  issue issue @relation(fields: [issue_id], references: [id])
  user  users @relation(fields: [user_id], references: [id])

  @@id([issue_id, user_id])
}
